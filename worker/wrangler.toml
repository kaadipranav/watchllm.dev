name = "watchllm-worker"
main = "src/index.ts"
compatibility_date = "2024-12-19"
compatibility_flags = ["nodejs_compat"]

# Development environment bindings (use wrangler secret put for production)
[vars]
# Set these via wrangler secret put for production:
# SUPABASE_URL = ""
# SUPABASE_ANON_KEY = ""
# UPSTASH_REDIS_REST_URL = ""
# UPSTASH_REDIS_REST_TOKEN = ""
# MONGODB_URI = ""
# MONGODB_DATABASE = ""
# MONGODB_COLLECTION = ""
# OPENAI_API_KEY = ""
# ANTHROPIC_API_KEY = ""
# GROQ_API_KEY = ""

# D1 Database for semantic caching
[[d1_databases]]
binding = "DB"
database_name = "watchllm-cache"
database_id = "05064211-5526-4438-8c68-f29824da1d60"

# ============================================================================
# Cloudflare Queues Configuration (Disabled for Free Plan)
# ============================================================================
# Queue for asynchronous event ingestion into ClickHouse
# This enables high-throughput data pipeline without blocking API responses
# ============================================================================

# Producer: Sends events to the queue from API handlers
# [[queues.producers]]
# queue = "watchllm-observability-events"
# binding = "OBSERVABILITY_QUEUE"

# Consumer: Processes events and inserts into ClickHouse
# [[queues.consumers]]
# queue = "watchllm-observability-events"
# max_batch_size = 100           # Process up to 100 messages per batch
# max_batch_timeout = 30         # Wait max 30 seconds to fill batch
# max_retries = 3                # Retry failed messages up to 3 times
# dead_letter_queue = "watchllm-observability-dlq"  # Failed messages go here

# Dead Letter Queue for failed event processing
# [[queues.producers]]
# queue = "watchllm-observability-dlq"
# binding = "OBSERVABILITY_DLQ"

# Optional: Consumer for DLQ to handle/alert on failed events (Disabled for Free Plan)
# [[queues.consumers]]
# queue = "watchllm-observability-dlq"
# max_batch_size = 10            # Smaller batch for error handling
# max_batch_timeout = 60         # Longer timeout for DLQ
# max_retries = 0                # Don't retry DLQ messages

[env.production]
name = "watchllm-worker-production"
# Custom domain for production
routes = [
  { pattern = "proxy.watchllm.dev/*", zone_name = "watchllm.dev" }
]

# Inherit vars from top level for production
[env.production.vars]
# Same as top level vars

# Inherit D1 database for production
[[env.production.d1_databases]]
binding = "DB"
database_name = "watchllm-cache"
database_id = "05064211-5526-4438-8c68-f29824da1d60"

# Production Queues Configuration (Disabled for Free Plan)
# [[env.production.queues.producers]]
# queue = "watchllm-observability-events"
# binding = "OBSERVABILITY_QUEUE"

# [[env.production.queues.consumers]]
# queue = "watchllm-observability-events"
# max_batch_size = 100
# max_batch_timeout = 30
# max_retries = 3
# dead_letter_queue = "watchllm-observability-dlq"

# [[env.production.queues.producers]]
# queue = "watchllm-observability-dlq"
# binding = "OBSERVABILITY_DLQ"

# [[env.production.queues.consumers]]
# queue = "watchllm-observability-dlq"
# max_batch_size = 10
# max_batch_timeout = 60
# max_retries = 0

# [env.development]
# name = "watchllm-worker-dev"

# Build configuration
[build]
command = ""

# Observability
[observability]
enabled = true
